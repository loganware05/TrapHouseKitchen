# ğŸš€ Pre-Deployment Checklist for Render

## âœ… Code Review Complete

All new features have been implemented and tested locally. Here's what needs to be verified before deploying to Render.

---

## ğŸ“‹ Pre-Deployment Checklist

### 1. âœ… Database Migration
**Status:** âœ… Ready
- Migration file created: `20260121235009_add_reviews_and_coupons`
- Migration runs automatically in `render.yaml` startCommand: `npx prisma migrate deploy`
- **Action Required:** None - Render will run migrations automatically

### 2. âœ… Environment Variables Setup

**Backend Environment Variables** (Set in Render Dashboard):
- [ ] `DATABASE_URL` - PostgreSQL connection string (from Render database)
- [ ] `JWT_SECRET` - Will be auto-generated by Render âœ…
- [ ] `JWT_EXPIRES_IN` - Set to `7d` âœ…
- [ ] `FRONTEND_URL` - Your frontend Render URL (e.g., `https://traphousekitchen-web.onrender.com`)
- [ ] `STRIPE_SECRET_KEY` - Production Stripe secret key (`sk_live_...`)
- [ ] `STRIPE_PUBLISHABLE_KEY` - Production Stripe publishable key (`pk_live_...`)
- [ ] `STRIPE_WEBHOOK_SECRET` - Stripe webhook signing secret (for payment webhooks)
- [ ] `RESEND_API_KEY` - Email service API key
- [ ] `FROM_EMAIL` - Set to `TrapHouse Kitchen <orders@traphousekitchen.com>` âœ…
- [ ] `CHEF_EMAIL` - Chef notification email address
- [ ] `NODE_ENV` - Set to `production` âœ…

**Frontend Environment Variables** (Set in Render Dashboard):
- [ ] `VITE_API_URL` - Your backend API URL (e.g., `https://traphousekitchen-api.onrender.com/api`)
- [ ] `VITE_STRIPE_PUBLISHABLE_KEY` - Same as backend publishable key (`pk_live_...`)

### 3. âœ… CORS Configuration
**Status:** âœ… Ready
- Production CORS uses `process.env.FRONTEND_URL` âœ…
- Development CORS allows multiple localhost ports âœ…
- **Action Required:** Ensure `FRONTEND_URL` is set correctly in Render

### 4. âœ… Build Commands
**Status:** âœ… Ready
- Backend build: `cd backend && npm install && npm run build` âœ…
  - Includes `prisma generate` âœ…
- Backend start: `cd backend && npx prisma migrate deploy && npm start` âœ…
  - Runs migrations automatically âœ…
- Frontend build: `npm install --prefix frontend && npm run build --prefix frontend` âœ…
- **Action Required:** None - Commands are correct

### 5. âœ… Stripe Configuration

**Production Stripe Setup:**
- [ ] Create production Stripe account (if not already done)
- [ ] Get production API keys (`sk_live_...` and `pk_live_...`)
- [ ] Configure Stripe webhook endpoint:
  - URL: `https://your-backend-url.onrender.com/api/webhooks/stripe`
  - Events to listen for:
    - `payment_intent.succeeded`
    - `payment_intent.payment_failed`
    - `charge.refunded`
- [ ] Copy webhook signing secret to `STRIPE_WEBHOOK_SECRET`
- [ ] Enable Apple Pay in Stripe Dashboard:
  - Settings â†’ Payment methods â†’ Apple Pay
  - Add your domain
  - Complete domain verification

**Action Required:** Complete Stripe production setup before deployment

### 6. âœ… Database Setup

**PostgreSQL Database:**
- [ ] Create PostgreSQL database in Render (if not exists)
- [ ] Copy connection string to `DATABASE_URL`
- [ ] Verify database is accessible
- [ ] **After first deploy:** Verify migrations ran successfully
  - Check Render logs for: `Applied migration 20260121235009_add_reviews_and_coupons`

**Action Required:** Create database and verify connection

### 7. âœ… Email Configuration

**Resend Email Setup:**
- [ ] Create Resend account (if not already done)
- [ ] Get API key
- [ ] Set `RESEND_API_KEY` in backend environment variables
- [ ] Set `FROM_EMAIL` (already configured âœ…)
- [ ] Set `CHEF_EMAIL` to chef's email address

**Action Required:** Set up Resend and configure email addresses

### 8. âœ… Frontend Build Configuration

**Static Site Settings:**
- [ ] Verify `staticPublishPath: frontend/dist` âœ…
- [ ] Verify rewrite rules for SPA routing âœ…
- [ ] Ensure `VITE_API_URL` points to production backend

**Action Required:** Verify environment variables are set

### 9. âœ… Security Checklist

- [ ] All secrets are in environment variables (not hardcoded) âœ…
- [ ] CORS configured for production domain only âœ…
- [ ] Rate limiting enabled âœ…
- [ ] JWT secret is strong (auto-generated by Render âœ…)
- [ ] Stripe webhook signature verification enabled âœ…
- [ ] Database connection uses SSL âœ…

**Action Required:** Review security settings

### 10. âœ… Testing After Deployment

**Post-Deployment Tests:**
- [ ] Health check: `https://your-backend-url.onrender.com/health`
- [ ] Frontend loads: `https://your-frontend-url.onrender.com`
- [ ] Can register new account
- [ ] Can login
- [ ] Can view menu
- [ ] Can place order
- [ ] Payment flow works (test with Stripe test mode first)
- [ ] Chef can login at `/chef/login`
- [ ] Chef can manage orders
- [ ] Reviews system works
- [ ] Coupons generate and apply correctly

**Action Required:** Test all features after deployment

---

## ğŸ”§ Critical Actions Before Deploying

### Must Do Before First Deploy:

1. **Set Up Stripe Production Account**
   ```bash
   # Get your production keys from Stripe Dashboard
   # Settings â†’ API keys â†’ Reveal live key
   ```

2. **Create PostgreSQL Database in Render**
   - Dashboard â†’ New â†’ PostgreSQL
   - Copy connection string
   - Add to backend `DATABASE_URL`

3. **Configure Stripe Webhook**
   - Stripe Dashboard â†’ Developers â†’ Webhooks
   - Add endpoint: `https://your-backend-url.onrender.com/api/webhooks/stripe`
   - Select events: `payment_intent.succeeded`, `payment_intent.payment_failed`
   - Copy signing secret

4. **Set Environment Variables**
   - Backend: All variables listed above
   - Frontend: `VITE_API_URL` and `VITE_STRIPE_PUBLISHABLE_KEY`

5. **Update render.yaml FRONTEND_URL**
   - After deploying, update `FRONTEND_URL` in backend env vars
   - Should match your actual frontend Render URL

---

## ğŸ“ Deployment Steps

### Step 1: Update render.yaml (if needed)
The `render.yaml` file is already configured correctly. Just verify:
- Backend build/start commands âœ…
- Frontend build command âœ…
- Environment variable placeholders âœ…

### Step 2: Deploy Backend First
1. Push code to GitHub
2. Connect repository to Render
3. Render will detect `render.yaml`
4. Create backend service
5. Set all backend environment variables
6. Deploy

### Step 3: Deploy Frontend
1. Create frontend static site
2. Set `VITE_API_URL` to backend URL
3. Set `VITE_STRIPE_PUBLISHABLE_KEY`
4. Deploy

### Step 4: Update Backend CORS
1. After frontend deploys, get frontend URL
2. Update backend `FRONTEND_URL` environment variable
3. Redeploy backend (or it will auto-redeploy)

### Step 5: Configure Stripe Webhook
1. Get backend URL from Render
2. Add webhook endpoint in Stripe Dashboard
3. Copy webhook secret to backend env vars
4. Redeploy backend

---

## ğŸ› Common Deployment Issues

### Issue: Migrations Fail
**Solution:** 
- Check database connection string
- Verify database exists
- Check Render logs for specific error

### Issue: CORS Errors
**Solution:**
- Verify `FRONTEND_URL` matches actual frontend URL
- Check for trailing slashes
- Ensure both URLs use HTTPS

### Issue: Stripe Payment Fails
**Solution:**
- Verify production Stripe keys are set
- Check webhook endpoint is configured
- Test with Stripe test mode first

### Issue: Frontend Can't Connect to Backend
**Solution:**
- Verify `VITE_API_URL` is set correctly
- Check backend is running (health check)
- Verify CORS allows frontend domain

---

## âœ… Final Verification

Before marking deployment as complete:

- [ ] All environment variables set
- [ ] Database migrations successful
- [ ] Backend health check passes
- [ ] Frontend loads correctly
- [ ] Login/register works
- [ ] Payment test succeeds (use test mode first)
- [ ] Chef dashboard accessible
- [ ] Reviews system functional
- [ ] Email notifications working
- [ ] Stripe webhooks receiving events

---

## ğŸ“ Post-Deployment Support

If issues arise after deployment:

1. **Check Render Logs**
   - Backend: Dashboard â†’ Logs
   - Frontend: Dashboard â†’ Logs

2. **Verify Environment Variables**
   - Dashboard â†’ Environment
   - Ensure all variables are set

3. **Test API Endpoints**
   ```bash
   curl https://your-backend-url.onrender.com/health
   curl https://your-backend-url.onrender.com/api/dishes
   ```

4. **Check Database**
   - Use Render database dashboard
   - Verify tables exist
   - Check migration status

---

## ğŸ¯ Summary

**Ready for Deployment:** âœ… YES

**What's Complete:**
- âœ… All code changes implemented
- âœ… Database migrations ready
- âœ… Build commands configured
- âœ… CORS properly set up
- âœ… Environment variables documented

**What You Need to Do:**
1. Set up Stripe production account
2. Create PostgreSQL database
3. Configure environment variables
4. Deploy backend
5. Deploy frontend
6. Configure Stripe webhook
7. Test everything

**Estimated Time:** 30-60 minutes (mostly Stripe setup)

---

**Good luck with deployment! ğŸš€**
